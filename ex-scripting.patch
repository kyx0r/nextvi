diff --git a/ex.c b/ex.c
index 5bf89e3b..e9fbafe6 100644
--- a/ex.c
+++ b/ex.c
@@ -36,6 +36,7 @@ int xsep = ':';			/* ex command separator */
 int xlim = -1;			/* rendering cutoff for non cursor lines */
 int xseq = 1;			/* undo/redo sequence */
 char *xregs[256];		/* string registers */
+char **xenvp;
 static int xbufsmax;		/* number of buffers */
 static int xbufsalloc = 10;	/* initial number of buffers */
 static int xgdep;		/* global command recursion depth */
@@ -1081,6 +1082,41 @@ static int ec_setenc(char *loc, char *cmd, char *arg)
 	return 0;
 }
 
+static int ec_script(char *loc, char *cmd, char *arg)
+{
+	char *rep;
+	char buf[100];
+	int row = xrow, off = xoff;
+	char *ln = lbuf_get(xb, row);
+	if (!*arg)
+		return 0;
+	setenv("NEXTVI_FT", ex_ft, 1);
+	itoa(row, buf);
+	setenv("NEXTVI_ROW", buf, 1);
+	itoa(ln ? uc_chr(ln, off) - ln : 0, buf);
+	setenv("NEXTVI_OFF", buf, 1);
+	itoa(off, buf);
+	setenv("NEXTVI_COFF", buf, 1);
+	setenv("NEXTVI_LINE", ln ? ln : "", 1);
+	if (!lbuf_wordend(xb, 0, 1, &row, &off)) {
+		rep = uc_sub(lbuf_get(xb, row), xoff, off+1);
+		setenv("NEXTVI_WORD", rep, 1);
+		free(rep);
+	} else
+		setenv("NEXTVI_WORD", "", 1);
+	if (!(xvis & 4) && cmd[1] == 'c') {
+		term_chr('\n');
+		xmpt = xmpt >= 0 ? 2 : xmpt;
+	}
+	xenvp = environ;
+	rep = cmd_pipe(arg, NULL, cmd[1] == 'x');
+	xenvp = NULL;
+	if (rep && cmd[1] == 'x')
+		ex_exec(rep);
+	free(rep);
+	return 0;
+}
+
 static int eo_val(char *arg)
 {
 	int val = atoi(arg);
@@ -1163,6 +1199,8 @@ static struct excmd {
 	EO(shape),
 	EO(seq),
 	EO(sep),
+	{"sc", ec_script},
+	{"sx", ec_script},
 	{"s", ec_substitute},
 	{"x!", ec_write},
 	{"x", ec_write},
diff --git a/term.c b/term.c
index 40e0cb4c..e02383fe 100644
--- a/term.c
+++ b/term.c
@@ -224,7 +224,10 @@ static int cmd_make(char **argv, int *ifd, int *ofd)
 			close(pipefds1[0]);
 			close(pipefds1[1]);
 		}
-		execvp(argv[0], argv);
+		if (xenvp)
+			execve(argv[0], argv, xenvp);
+		else
+			execvp(argv[0], argv);
 		exit(1);
 	}
 	if (ifd)
diff --git a/vi.h b/vi.h
index ae224584..31c7f9b2 100644
--- a/vi.h
+++ b/vi.h
@@ -9,6 +9,14 @@ If something is listed here, it must be used across multiple
 files and thus is never static.
 */
 
+#ifdef __APPLE__
+#include <crt_externs.h>
+#define environ (*_NSGetEnviron())
+#else
+extern char **environ;
+#endif
+extern char **xenvp;
+
 /* helper macros */
 #define LEN(a)		(int)(sizeof(a) / sizeof((a)[0]))
 #define MIN(a, b)	((a) < (b) ? (a) : (b))
