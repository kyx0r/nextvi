#!/bin/sh
# Generated by patch2vi from unified diff
# Separator: '@'
set -e

# Path to nextvi (adjust as needed)
VI=${VI:-vi}

# Verify that VI is nextvi
if ! $VI -? 2>&1 | grep -q 'Nextvi'; then
    echo "Error: $VI is not nextvi" >&2
    echo "Set VI environment variable to point to nextvi" >&2
    exit 1
fi

# Patch: ex.c
EXINIT="rcm:|sc! @|vis 6@1609a 
void ex_done(void)
{
	for (int i = 0; i < LEN(tempbufs); i++)
		if (tempbufs[i].lb) {
			free(tempbufs[i].path);
			lbuf_free(tempbufs[i].lb);
		}
	for (int i = 0; i < xbufcur; i++)
		bufs_free(i);
	rset_free(xkwdrs);
	free(bufs);
}
.
@vis 4@wq" $VI -e 'ex.c'

# Patch: regex.c
EXINIT="rcm:|sc! @|vis 6@638a 	memset(sdense, 0, sizeof(int) * prog->sparsesz);
.
@vis 4@wq" $VI -e 'regex.c'

# Patch: ren.c
EXINIT="rcm:|sc! @|vis 6@409a 
void syn_done(void)
{
	for (; ftmidx >= 0; ftmidx--)
		rset_free(ftmap[ftmidx].rs);
	rset_free(syn_ftrs);
}
.
@92a void ren_done(void)
{
	rset_free(dir_rslr);
	rset_free(dir_rsrl);
	rset_free(dir_rsctx);
	for (int i = 0; i < LEN(rstates); i++) {
		if (rstate[i].col) {
			free(rstate[i].col - 2);
			free(rstate[i].pos);
		}
	}
}

.
@vis 4@wq" $VI -e 'ren.c'

# Patch: vi.c
EXINIT="rcm:|sc! @|vis 6@1834a 	vi_regdone();
	syn_done();
	ren_done();
	led_done();
.
@1828a 	free(ibuf);
	rset_free(fsincl);
.
@1827a 	ex_done();
.
@438a static void vi_regdone(void)
{
	for (int i = 0; i < LEN(xregs); i++)
		if (xregs[i])
			sbuf_free(xregs[i])
}

.
@vis 4@wq" $VI -e 'vi.c'

# Patch: vi.h
EXINIT="rcm:|sc! @|vis 6@480a void ex_done(void);
.
@271a void syn_done(void);
.
@233a void dir_done(void);
.
@vis 4@wq" $VI -e 'vi.h'
