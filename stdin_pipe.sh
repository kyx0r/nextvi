#!/bin/sh
# Generated by patch2vi from unified diff
# Separator: '@'
set -e

# Path to nextvi (adjust as needed)
VI=${VI:-vi}

# Verify that VI is nextvi
if ! $VI -? 2>&1 | grep -q 'Nextvi'; then
    echo "Error: $VI is not nextvi" >&2
    echo "Set VI environment variable to point to nextvi" >&2
    exit 1
fi

# Patch: ex.c
EXINIT="rcm:|sc! @|vis 6@1582a 	signal(SIGINT, SIG_DFL); /* got past init? ok remove ^c */
.
@vis 4@vis 6@1581a 	if (stdin_fd) {
		if (i)
			ec_edit(NULL, \"\", \"\");
		i = lbuf_rd(xb, STDIN_FILENO, 0, lbuf_len(xb));
		term_done();
		term_init();
		lbuf_saved(xb, 1);
		if (i)
			ex_print(\"stdin read failed\", msg_ft)
		else
			ec_edit(\"\", NULL, \"\"); /* shebang patch compat */
		close(0);
		if (dup2(stdin_fd, 0) == -1) {
			fprintf(stderr, \"error: %s\\n\", \"dup2\");
			close(stdin_fd);
			exit(1);
		}
	}
.
@vis 4@vis 6@1579;10;10c !n && stdin_fd ? NULL : 
.
@vis 4@vis 6@1576a 	int i = n;
.
@vis 4@vis 6@1574;19;19c  + !!stdin_fd
.
@vis 4@vis 6@373a 	if (!loc)
		return fd < 0 || rd ? xuerr : NULL;
	ret:
.
@vis 4@vis 6@355c 	int fd = 0, len, rd = 0, cd = 0;
	if (!cmd)
		goto ret;
.
@vis 4@wq" $VI -e 'ex.c'

# Patch: term.c
EXINIT="rcm:|sc! @|vis 6@349;11;23c stdin_fd
.
@vis 4@vis 6@306;20;21c stdin_fd
.
@vis 4@vis 6@162,163c 				read(stdin_fd, ibuf, 1) <= 0) {
			xquit = !isatty(stdin_fd) ? -1 : xquit;
.
@vis 4@vis 6@158a 		ufd.fd = stdin_fd;
.
@vis 4@vis 6@40;11;12c stdin_fd
.
@vis 4@vis 6@31a 	isig = 1;
.
@vis 4@vis 6@26;12;13c stdin_fd
.
@vis 4@vis 6@20,21c 	if (!isig && stdin_fd)
		newtermios.c_lflag &= ~(ICANON);
	else
		newtermios.c_lflag &= ~(ICANON | ISIG | ECHO);
	tcsetattr(stdin_fd, TCSAFLUSH, &newtermios);
.
@vis 4@vis 6@18;11;12c stdin_fd
.
@vis 4@vis 6@8a int stdin_fd;
static int isig;
.
@vis 4@wq" $VI -e 'term.c'

# Patch: vi.c
EXINIT="rcm:|sc! @|vis 6@1804c 		} else if (!argv[i][1])
			stdin_fd = MAX(0, open(ctermid(NULL), O_RDONLY));
.
@vis 4@vis 6@1789a 	sigaction(SIGINT, &sa, NULL);
.
@vis 4@wq" $VI -e 'vi.c'

# Patch: vi.h
EXINIT="rcm:|sc! @|vis 6@537a extern int stdin_fd;
.
@vis 4@wq" $VI -e 'vi.h'
