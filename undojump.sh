#!/bin/sh
# Generated by patch2vi from unified diff
# Separator: '@'
set -e

# Path to nextvi (adjust as needed)
VI=${VI:-vi}

# Verify that VI is nextvi
if ! $VI -? 2>&1 | grep -q 'Nextvi'; then
    echo "Error: $VI is not nextvi" >&2
    echo "Set VI environment variable to point to nextvi" >&2
    exit 1
fi

# Patch: lbuf.c
EXINIT="rcm:|sc! \\\\@|vis 6@%;f> 	return pos >= 0 && pos < lb->ln_n \\\\? lb->ln\\\\[pos\\\\] : NULL;
\\\\}
@??!.-5,.+5p\@p FAIL line 382\@q!@;=
@.+2a int lbuf_undojump(struct lbuf *lb, int *pos, int *off)
{
	struct lopt *lo;
	static int last_hist_u;
	int hist_u = lb->hist_u;
	int useq;
	int rpos = 0;
	int ret = 0;
	if (!last_hist_u) {
		last_hist_u = hist_u;
		ret = 2;
	}
	if (hist_u) {
		do {
			lo = &lb->hist[hist_u - 1];
			useq = lo->seq;
			while (hist_u && lb->hist[hist_u - 1].seq == useq)
				lo = &lb->hist[--hist_u];
		} while (hist_u && hist_u >= last_hist_u);
		last_hist_u = hist_u;
		hist_u = lb->hist_u;
		while (hist_u != last_hist_u) {
			lo = &lb->hist[--hist_u];
			if (lb->hist[last_hist_u].pos > lo->pos) {
				rpos += lo->n_ins;
				rpos -= lo->n_del;
			}
		}
	} else
		return ret ? ret : 1;
	*pos = rpos + lb->hist[last_hist_u].pos;
	*off = lo->pos_off;
	return ret;
}

.
@vis 4@wq" $VI -e 'lbuf.c'

# Patch: vi.c
EXINIT="rcm:|sc! \\\\@|vis 6@%;f> 				vi_hidch = !vi_hidch;
				vi_mod \\\\|= 1;
				break;@??!.-5,.+5p\@p FAIL line 1447\@q!@;=
@.+2a 			case TK_CTL('o'):
				next_hop:
				if (lbuf_undojump(xb, &xrow, &xoff))
					vi_drawmsg_mpt(\"undo jmp failed\")
				else if (xrow == nrow)
					goto next_hop;
				vi_col = vi_off2col(xb, xrow, xoff);
				xoff = vi_col2off(xb, xrow, vi_col);
				xtop = MAX(0, xrow - xrows / 2);
				vi_mod = 1;
				break;
.
@vis 4@wq" $VI -e 'vi.c'

# Patch: vi.h
EXINIT="rcm:|sc! \\\\@|vis 6@%;f> void lbuf_smark\\\\(struct lbuf \\\\*lb, struct lopt \\\\*lo, int beg, int o1\\\\);
void lbuf_emark\\\\(struct lbuf \\\\*lb, struct lopt \\\\*lo, int end, int o2\\\\);
struct lopt \\\\*lbuf_opt\\\\(struct lbuf \\\\*lb, int beg, int o1, int n_del\\\\);@??!.-5,.+5p\@p FAIL line 180\@q!@;=
@.+2a int lbuf_undojump(struct lbuf *lb, int *pos, int *off);
.
@vis 4@wq" $VI -e 'vi.h'
