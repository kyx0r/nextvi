#!/bin/sh
# Generated by patch2vi from unified diff
# Separator: '@'
set -e

# Path to nextvi (adjust as needed)
VI=${VI:-vi}

# Patch: conf.c
EXINIT="rcm:|sc! @|vis 6@254a 	{grep_ft, \"^(.+?):([0-9]+):(.+)\", A(MA, GR1, CY, AY1)},
	{grep_ft, NULL, A(AY | SYN_BGMK(RE1)), 1, 3},

.
@vis 4@vis 6@31a char grep_ft[] = \"/g\";	/* grep buffer */
.
@vis 4@wq" $VI -e 'conf.c'

# Patch: ex.c
EXINIT="rcm:|sc! @|vis 6@41c struct buf tempbufs[3];		/* temporary buffers, for internal use */
.
@vis 4@wq" $VI -e 'ex.c'

# Patch: vi.c
EXINIT="rcm:|sc! @|vis 6@1799a 	temp_open(2, \"/grep/\", grep_ft);
.
@vis 4@vis 6@1436a 				case 'x':
					temp_switch(2, 1);
					vi_mod = 1;
					break;
.
@vis 4@vis 6@1293c 				if (!strcmp(xb_path, \"/grep/\")) {
					int subs[2];
					rset *rs = rset_make(1, (char*[]){\":[0-9]+:\"}, 0);
					if (rset_find(rs, buf, subs, 0) >= 0) {
						buf[subs[0]] = xsep;
						buf[subs[1]-1] = '\\n';
						buf[subs[1]] = '\\0';
					}
					rset_free(rs);
				}
				term_push(buf, strlen(buf));
.
@vis 4@vis 6@733a 		} else if (mv == TK_CTL('x')) {
			term_exec(\"\", 1, '&')
			temp_pos(2, -1, 0, 0);
			temp_switch(2, 0);
			sbuf *gstats; sbuf_make(gstats, 1024)
			char nbuf[100];
			int colpos = 0;
			fspos = 0;
			while (fs_search(2, 1, row, off)) {
				sbuf_str(gstats, xb_path)
				sbuf_chr(gstats, ':')
				colpos = gstats->s_n;
				#define nextrow() \\
				itoa((*row)+1, nbuf); \\
				sbuf_str(gstats, nbuf) \\
				sbuf_chr(gstats, ':') \\
				sbufn_str(gstats, lbuf_get(xb, *row)) \\
				temp_write(2, gstats->s); \\
				(*row)++; \\

				nextrow()
				while (!vi_search('n', cnt, row, off, 0)) {
					sbuf_cut(gstats, colpos)
					nextrow()
				}
				sbuf_cut(gstats, 0)
			}
			sbuf_free(gstats)
			for (i = xbufcur-1; i >= 0 && bufs[i].mtime == -1; i--)
				ex_bufpostfix(&bufs[i], 1);
			temp_switch(2, 0);
			lbuf_jump(xb, '[', row, off);
			*off = 0;
			syn_reloadft(syn_addhl(xregs['/'] ? xregs['/']->s : NULL, 3), xic ? REG_ICASE : 0);
.
@vis 4@vis 6@732c 			fs_search(0, 1, row, off);
.
@vis 4@vis 6@713a 	case TK_CTL('x'):
.
@vis 4@vis 6@538c 		fssearch(ret && xrow)
.
@vis 4@vis 6@522c 		fssearch(ret && xrow && again != 2)
.
@vis 4@vis 6@518c 	int ret, len;
.
@vis 4@vis 6@515c static int fs_search(int again, int cnt, int *row, int *off)
.
@vis 4@vis 6@504c if (isbuffer) { \\
.
@vis 4@vis 6@499c #define fssearch(isbuffer) \\
.
@vis 4@wq" $VI -e 'vi.c'

# Patch: vi.h
EXINIT="rcm:|sc! @|vis 6@448c extern struct buf tempbufs[3];
.
@vis 4@wq" $VI -e 'vi.h'
