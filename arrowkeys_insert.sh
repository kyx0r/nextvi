#!/bin/sh
# Generated by patch2vi from unified diff
# Separator: '@'
set -e

# Path to nextvi (adjust as needed)
VI=${VI:-vi}

# Verify that VI is nextvi
if ! $VI -? 2>&1 | grep -q 'Nextvi'; then
    echo "Error: $VI is not nextvi" >&2
    echo "Set VI environment variable to point to nextvi" >&2
    exit 1
fi

# Patch: led.c
EXINIT="rcm:|sc! @|vis 6@694;37c , 1
.
@663a 	sbufn_str(sb, post)
	free(postref);
.
@650;29;33c NULL
.
@614a 		case '\\033':;	/* Arrow keys */
			char cbuf[1];
			cbuf[0] = '\\0';
			int fl = fcntl(STDIN_FILENO, F_GETFL);
			fcntl(STDIN_FILENO, F_SETFL, fl | O_NONBLOCK);
			read(STDIN_FILENO, cbuf, 1);
			if (*cbuf == '[') {
				read(STDIN_FILENO, cbuf, 1);
				fcntl(STDIN_FILENO, F_SETFL, fl);
				if (ai_max < 0) {
					/* Prompt mode: handle arrows internally */
					int lc, clen, plen;
					char *newpost;
					switch (*cbuf) {
					case 'D':  /* ← */
						if (len > pre) {
							lc = led_lastchar(sb->s + pre) + pre;
							clen = len - lc;
							plen = strlen(*post);
							newpost = malloc(plen + clen + 1);
							memcpy(newpost, sb->s + lc, clen);
							memcpy(newpost + clen, *post, plen + 1);
							free(*postref);
							*postref = *post = newpost;
							postn++;
							sbuf_cut(sb, lc)
						}
						continue;
					case 'C':  /* → */
						if (**post) {
							clen = uc_len(*post);
							sbuf_mem(sb, *post, clen)
							plen = strlen(*post);
							newpost = malloc(plen - clen + 1);
							memcpy(newpost, *post + clen, plen - clen + 1);
							free(*postref);
							*postref = *post = newpost;
							postn--;
						}
						continue;
					case 'A':  /* ↑ - history */
					case 'B':  /* ↓ - history */
						continue;
					}
				}
				vi_insmov = *cbuf;
				return *cbuf;
			}
			fcntl(STDIN_FILENO, F_SETFL, fl);
			return c;
.
@414c 		led_printparts(sb, pre, ps, *post, postn, ai_max, !vi_insmov);
		vi_insmov = 0;
.
@310,311c 	if (print) {
		syn_blockhl = -1;
		led_crender(r->s, -1, vi_lncol, xleft, xleft + xcols - vi_lncol);
	}
.
@283;34c , int print
.
@5a static int vi_insmov;
.
@vis 4@wq" $VI -e 'led.c'

# Patch: vi.c
EXINIT="rcm:|sc! @|vis 6@1515a 				_break:
				vi_mod = 0;
				break;
.
@1512a 				switch (k) {
				case 'A':	/* ↑ */
					term_back(!lmodified ? c : 'i');
					if (lmodified)
						vi_col = vi_off2col(xb, xrow, xoff);
					xrow--;
					xrow = xrow < 0 ? 0 : xrow;
					xoff = vi_col2off(xb, xrow, vi_col);
					lmodified = 0;
					goto _break;
				case 'B':	/* ↓ */
					term_back(!lmodified ? c : 'i');
					if (lmodified)
						vi_col = vi_off2col(xb, xrow, xoff);
					xrow++;
					xoff = vi_col2off(xb, xrow, vi_col);
					lmodified = 0;
					goto _break;
				case 'D':	/* ← */
					term_back('i');
					xoff--;
					xoff = xoff < 0 ? 0 : xoff;
					vi_col = vi_off2col(xb, xrow, xoff);
					goto _break;
				case 'C':	/* → */
					term_back(*uc_chr(lbuf_get(xb, xrow), xoff+2) ? 'i' : 'A');
					xoff++;
					if (*uc_chr(lbuf_get(xb, xrow), xoff))
						vi_col = vi_off2col(xb, xrow, xoff);
					goto _break;
				}
.
@1055a 		lmodified = 1;
	} else
		lmodified = 0;
.
@1054;32c  {
.
@883a 	lmodified = 1;
.
@852a static int lmodified;

.
@vis 4@wq" $VI -e 'vi.c'
