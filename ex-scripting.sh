#!/bin/sh
# Generated by patch2vi from unified diff
# Separator: '@'
set -e

# Path to nextvi (adjust as needed)
VI=${VI:-vi}

# Verify that VI is nextvi
if ! $VI -? 2>&1 | grep -q 'Nextvi'; then
    echo "Error: $VI is not nextvi" >&2
    echo "Set VI environment variable to point to nextvi" >&2
    exit 1
fi

# Patch: ex.c
EXINIT="rcm:|sc! @|vis 6@1392a 	{\"sr\", ec_script},
	{\"sx\", ec_script},
.
@1298a static void *ec_script(char *loc, char *cmd, char *arg)
{
	char *rep;
	char buf[100];
	int row = xrow, off = xoff, ret = 0;
	char *ln = lbuf_get(xb, row);
	if (!*arg)
		return xserr;
	setenv(\"NEXTVI_FT\", ex_ft, 1);
	itoa(row, buf);
	setenv(\"NEXTVI_ROW\", buf, 1);
	itoa(ln ? uc_chr(ln, off) - ln : 0, buf);
	setenv(\"NEXTVI_OFF\", buf, 1);
	itoa(off, buf);
	setenv(\"NEXTVI_COFF\", buf, 1);
	setenv(\"NEXTVI_LINE\", ln ? ln : \"\", 1);
	if (!lbuf_wordend(xb, 0, 1, &row, &off)) {
		rep = uc_sub(lbuf_get(xb, row), xoff, off+1);
		setenv(\"NEXTVI_WORD\", rep, 1);
		free(rep);
	} else
		setenv(\"NEXTVI_WORD\", \"\", 1);
	if (!(xvis & 4) && cmd[1] == 'c') {
		term_chr('\\n');
		xmpt = xmpt >= 0 ? 2 : xmpt;
	}
	xenvp = environ;
	sbuf *sb = cmd_pipe(arg, NULL, cmd[1] == 'x', &ret);
	xenvp = NULL;
	if (sb && cmd[1] == 'x')
		ex_exec(sb->s);
	free(sb);
	return ret ? xuerr : NULL;
}

.
@39a char **xenvp;
.
@vis 4@wq" $VI -e 'ex.c'

# Patch: term.c
EXINIT="rcm:|sc! @|vis 6@241c 		if (xenvp)
			execve(argv[0], argv, xenvp);
		else
			execvp(argv[0], argv);
.
@vis 4@wq" $VI -e 'term.c'

# Patch: vi.h
EXINIT="rcm:|sc! @|vis 6@11a #ifdef __APPLE__
#include <crt_externs.h>
#define environ (*_NSGetEnviron())
#else
extern char **environ;
#endif
extern char **xenvp;

.
@vis 4@wq" $VI -e 'vi.h'
