#!/bin/sh
# Generated by patch2vi from unified diff
# Separator: '@'
set -e

# Path to nextvi (adjust as needed)
VI=${VI:-vi}

# Verify that VI is nextvi
if ! $VI -? 2>&1 | grep -q 'Nextvi'; then
    echo "Error: $VI is not nextvi" >&2
    echo "Set VI environment variable to point to nextvi" >&2
    exit 1
fi

# Patch: ex.c
EXINIT="rcm:|sc! @|vis 6@1603a 	} else {
		char *homeenv = getenv(\"HOME\");
		if (homeenv) {
			char exrc[PATH_MAX];
			snprintf(exrc, sizeof(exrc), \"%s/.exrc\", homeenv);
			load_exrc(exrc);
		}
	}
	if (xexrc) {
		char buf[PATH_MAX];
		getcwd(buf, PATH_MAX);
		if (strcmp(buf, getenv(\"HOME\")) != 0)
			load_exrc(\".exrc\");
	}
.
@1602;28c  {
.
@1590a void ex_script(FILE *fp)
{
	char done = 0;
	do {
		size_t n = 128, i = 0;
		int c;
		char *ln = malloc(128);
		while ((c = fgetc(fp)) != EOF && c != '\\n') {
			if (i >= n - 2) {
				n += 128;
				ln = erealloc(ln, n);
			}
			ln[i++] = c;
		}
		if (!i) {
			free(ln);
			done = 1;
			break;
		}
		ln[i] = '\\0';
		ex_command(ln);
		free(ln);
	} while(!done);
}

void load_exrc(char *exrc)
{
	struct stat st;
	if (stat(exrc, &st) == 0) {
		if (st.st_uid == getuid() && !(st.st_mode & S_IWGRP) && !(st.st_mode & S_IWOTH)) {
			FILE *fp = fopen(exrc, \"r\");
			if (fp) {
				ex_script(fp);
				fclose(fp);
			} else {
				fprintf(stderr, \"Cannot open ~/.exrc\\n\");
				exit(EXIT_FAILURE);
			}
		} else {
			fprintf(stderr, \"Bad permissions on ~/.exrc\\n\");
			exit(EXIT_FAILURE);
		}
	}
}

.
@1373a 	EO(exrc),
.
@1337a EO(exrc)
.
@39a int xexrc = 0;			/* read .exrc from the current directory */
.
@vis 4@wq" $VI -e 'ex.c'
