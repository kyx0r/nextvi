#!/bin/sh
# Generated by patch2vi from unified diff
# Separator: '@'
set -e

# Path to nextvi (adjust as needed)
VI=${VI:-vi}

# Verify that VI is nextvi
if ! $VI -? 2>&1 | grep -q 'Nextvi'; then
    echo "Error: $VI is not nextvi" >&2
    echo "Set VI environment variable to point to nextvi" >&2
    exit 1
fi

# Patch: led.c
EXINIT="rcm:|sc! @|vis 6@217c 				i = p->off - stt[atti];
.
@vis 4@vis 6@207c 		syn_highlight(att, bound ? bound : s0, MIN(n, fcterm));
.
@vis 4@vis 6@205c 	memset(att, 0, MIN(n, fcterm+1) * sizeof(att[0]));
.
@vis 4@vis 6@183a 		l = cend <= r->cmax ? r->col[cend] : -1;
		for (o = 0; l > 0 && l <= n && o < LEDFORW; o++) {
			if (r->pos[l] >= cend && c < fcterm) {
				att[c++] = l;
			}
			l += ctx;
		}
.
@vis 4@vis 6@178c 		l = cbeg <= r->cmax ? r->col[cbeg] : -1;
		for (o = 0; l > 0 && l <= n && o < LEDBACK; o++) {
			if (r->pos[l] < cbeg && c < fcterm) {
				atti++;
				att[c++] = l;
			}
			l -= ctx;
		}
		for (i = 0; i < cterm;) {
.
@vis 4@vis 6@167a 		c = 0;
.
@vis 4@vis 6@154,156c 	int att[fcterm+1];	/* att[i]: the attributes of i-th character */
	int stt[fcterm+1];	/* stt[i]: remap off indexes */
	int ctt[fcterm+1];	/* ctt[i]: cterm bound attrs */
.
@vis 4@vis 6@148a 	int fcbeg = cbeg - LEDBACK < 0 ? 0 : cbeg - LEDBACK;
	int fcend = cend + LEDFORW;
	int fcterm = fcend - fcbeg; /* fake the render dimensions */
.
@vis 4@vis 6@142a #define LEDBACK 300
#define LEDFORW 300

.
@vis 4@wq" $VI -e 'led.c'
