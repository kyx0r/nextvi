diff --git a/ex.c b/ex.c
index 19ede9aa..1c46d8c7 100644
--- a/ex.c
+++ b/ex.c
@@ -394,10 +394,10 @@ void ex_bufpostfix(struct buf *p, int clear)
 	lbuf_saved(p->lb, clear);
 }
 
-#define readfile(errchk) \
+#define readfile(errchk, init) \
 fd = open(xb_path, O_RDONLY); \
 if (fd >= 0) { \
-	errchk lbuf_rd(xb, fd, 0, lbuf_len(xb)); \
+	errchk lbuf_rd(xb, fd, 0, lbuf_len(xb), init); \
 	close(fd); \
 } \
 
@@ -413,7 +413,7 @@ int ex_edit(const char *path, int len)
 		return 1;
 	}
 	bufs_switch(bufs_open(path, len));
-	readfile()
+	readfile(, 1)
 	return 0;
 }
 
@@ -434,7 +434,7 @@ static void *ec_edit(char *loc, char *cmd, char *arg)
 		bufs_switch(bufs_open(arg+cd, len));
 		cd = 3; /* XXX: quick hack to indicate new lbuf */
 	}
-	readfile(rd =)
+	readfile(rd =, cd == 3)
 	if (cd == 3 || (!rd && fd >= 0)) {
 		ex_bufpostfix(ex_buf, arg[0]);
 		syn_setft(xb_ft);
@@ -508,7 +508,7 @@ static void *ec_read(char *loc, char *cmd, char *arg)
 			ret = "open failed";
 			goto err;
 		}
-		if (lbuf_rd(lb, fd, 0, 0)) {
+		if (lbuf_rd(lb, fd, 0, 0, 0)) {
 			ret = "read failed";
 			goto err;
 		}
diff --git a/lbuf.c b/lbuf.c
index 912bcd5d..b7bed619 100644
--- a/lbuf.c
+++ b/lbuf.c
@@ -203,20 +203,71 @@ void lbuf_edit(struct lbuf *lb, char *buf, int beg, int end, int o1, int o2)
 		lo->ins = (char**)sb->s;
 }
 
-int lbuf_rd(struct lbuf *lb, int fd, int beg, int end)
+int lbuf_rd(struct lbuf *lb, int fd, int beg, int end, int init)
 {
-	long nr;
-	sbuf_smake(sb, 1048575)  /* caps at 2147481600 on 32 bit */
-	while ((nr = read(fd, sb->s + sb->s_n, sb->s_sz - sb->s_n)) > 0) {
-		sb->s_n += nr;
-		if (sb->s_n >= sb->s_sz) {
-			if (sb->s_n > INT_MAX / 2)
-				break;
-			sbuf_extend(sb, sb->s_n * 2)
+	long nr, l, nins = 0, nl = 0;
+	struct linfo *n, *cn = NULL;
+	sbuf_smake(sb, init ? 0 : 1048575)
+	if (!init) {
+	        while ((nr = read(fd, sb->s + sb->s_n, sb->s_sz - sb->s_n)) > 0) {
+	                sb->s_n += nr;
+	                if (sb->s_n >= sb->s_sz) {
+	                        if (sb->s_n > INT_MAX / 2)
+	                                break;
+	                        sbuf_extend(sb, sb->s_n * 2)
+	                }
+	        }
+	        sbuf_null(sb)
+		lbuf_edit(lb, sb->s, beg, end, 0, 0);
+	        free(sb->s);
+	        return nr != 0;
+	}
+	const int rchunk = 4096;
+	char sm[rchunk+1], *s, *ln;
+	while ((nr = read(fd, sm, rchunk)) > 0) {
+		s = sm;
+		s[nr] = '\0';
+		for (; *s; nins++) {
+			l = linelength(s);
+			nl = (s[l - !!l] == '\n');
+			int l_nonl = l - nl;
+			if (!cn) {
+				n = emalloc(l_nonl + 7 + sizeof(struct linfo));
+				n->len = l_nonl;
+				n->grec = 0;
+				ln = (char*)(n + 1);
+				memcpy(ln, s, l_nonl);
+				memset(&ln[l_nonl + 1], 0, 5);	/* fault tolerance pad */
+				ln[l_nonl] = '\n';
+			} else {
+				n = erealloc(cn, cn->len + l_nonl + 7 + sizeof(struct linfo));
+				ln = (char*)(n + 1);
+				memcpy(ln + n->len, s, l_nonl);
+				n->len += l_nonl;
+				cn = NULL;
+				memset(&ln[n->len + 1], 0, 5);	/* fault tolerance pad */
+				ln[n->len] = '\n';
+			}
+			sbuf_mem(sb, &ln, (int)sizeof(ln))
+			s += l;
+		}
+		if (s - sm != rchunk) {
+			nr = 0;
+			break;
+		}
+		if (!nl) {
+			cn = n;
+			nins--;
+			sb->s_n -= sizeof(ln);
 		}
 	}
 	sbuf_null(sb)
 	lbuf_edit(lb, sb->s, beg, end, 0, 0);
+	lb->ln_n = nins;
+	lb->ln = emalloc((nins + 512) * sizeof(lb->ln[0]));
+	lb->ln_sz = nins + 512;
+	for (int i = 0; i < nins; i++)
+		lb->ln[i] = *((char**)sb->s + i);
 	free(sb->s);
 	return nr != 0;
 }
diff --git a/vi.h b/vi.h
index 964e4b1d..0c729ad0 100644
--- a/vi.h
+++ b/vi.h
@@ -164,7 +164,7 @@ struct lbuf {
 #define lbuf_i(lb, pos) ((struct linfo*)(lb->ln[pos] - sizeof(struct linfo)))
 struct lbuf *lbuf_make(void);
 void lbuf_free(struct lbuf *lb);
-int lbuf_rd(struct lbuf *lb, int fd, int beg, int end);
+int lbuf_rd(struct lbuf *lb, int fd, int beg, int end, int init);
 int lbuf_wr(struct lbuf *lb, int fd, int beg, int end);
 void lbuf_edit(struct lbuf *lb, char *s, int beg, int end, int o1, int o2);
 void lbuf_region(struct lbuf *lb, sbuf *sb, int r1, int o1, int r2, int o2);
