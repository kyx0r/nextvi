#!/bin/sh
# Generated by patch2vi from unified diff
# Separator: '@'
set -e

# Path to nextvi (adjust as needed)
VI=${VI:-vi}

# Verify that VI is nextvi
if ! $VI -? 2>&1 | grep -q 'Nextvi'; then
    echo "Error: $VI is not nextvi" >&2
    echo "Set VI environment variable to point to nextvi" >&2
    exit 1
fi

# Patch: ex.c
EXINIT="rcm:|sc! \\\\@|vis 6@%;f> int xshape = 1;			/\\\\* perform letter shaping \\\\*/
int xorder = 1;			/\\\\* change the order of characters \\\\*/
int xts = 8;			/\\\\* number of spaces for tab \\\\*/@??!.-5,.+5p\@p FAIL line 14\@q!@;=
@.+2a int xqe = 1000;			/* exit insert via kj (delay in ms) */
.
@.,$;f+ EO\\\\(pac\\\\) EO\\\\(pr\\\\) EO\\\\(ai\\\\) EO\\\\(err\\\\) EO\\\\(ish\\\\) EO\\\\(ic\\\\) EO\\\\(grp\\\\) EO\\\\(mpt\\\\) EO\\\\(rcm\\\\)
EO\\\\(shape\\\\) EO\\\\(seq\\\\) EO\\\\(ts\\\\) EO\\\\(td\\\\) EO\\\\(order\\\\) EO\\\\(hll\\\\) EO\\\\(hlw\\\\)
EO\\\\(hlp\\\\) EO\\\\(hlr\\\\) EO\\\\(hl\\\\) EO\\\\(lim\\\\) EO\\\\(led\\\\) EO\\\\(vis\\\\)@??!.-5,.+5p\@p FAIL line 1343\@q!@;=
@.+2a EO(qe)
.
@.,$;f+ 	\\\\{\"g\", ec_glob\\\\},
	EO\\\\(mpt\\\\),
	\\\\{\"m\", ec_mark\\\\},@??!.-5,.+5p\@p FAIL line 1404\@q!@;=
@.+2a 	EO(qe),
.
@vis 4@wq" $VI -e 'ex.c'

# Patch: led.c
EXINIT="rcm:|sc! \\\\@|vis 6@%;f> 	restore\\\\(xvis\\\\)
\\\\}
@??!.-5,.+5p\@p FAIL line 406\@q!@;=
@.+2a static int gettime_ms(void)
{
	struct timespec t;
	if (clock_gettime(CLOCK_MONOTONIC, &t) < 0)
		return 0;
	return t.tv_sec * 1000 + t.tv_nsec / 1000000;
}

.
@.,$;f+ 				exbuf_load\\\\(ex_buf\\\\)
			\\\\}
			continue; \\\\}@??!.-5,.+5p\@p FAIL line 632\@q!@;=
@.+2a 		case 'j':
			if (xqe && (gettime_ms() - is->quickexit) < xqe) {
				if (len - pre > 0 && sb->s[led_lastchar(sb->s)] == 'k') {
					term_push(\"\", 2);
					continue;
				}
			}
			goto _default;
		case 'k':
			is->quickexit = gettime_ms();
.
@.-1@>		default:>a _default:
.
@??!.-5,.+5p\@p FAIL line 633\@q!@vis 4@wq" $VI -e 'led.c'

# Patch: vi.c
EXINIT="rcm:|sc! \\\\@|vis 6@%;f> #include <dirent\\\\.h>
#include <signal\\\\.h>
#include <unistd\\\\.h>@??!.-5,.+5p\@p FAIL line 9\@q!@;=
@.+2a #include <time.h>
.
@.,$;f+ 				k = vc_insert\\\\(c\\\\);
				ins:
				vi_mod \\\\|= !xpac && xrow == orow \\\\? 8 : 1;@??!.-5,.+5p\@p FAIL line 1506\@q!@;=
@.+2a 				if (xqe)
					vi_mod |= 2;
.
@vis 4@wq" $VI -e 'vi.c'

# Patch: vi.h
EXINIT="rcm:|sc! \\\\@|vis 6@%;f> 	int p_reg;
	int lsug;
	int sug_pt;@??!.-5,.+5p\@p FAIL line 372\@q!@;=
@.+2a 	int quickexit;
.
@.,$;f+ is\\\\.p_reg = 0; \\\\\\\\
is\\\\.lsug = 0; \\\\\\\\
is\\\\.sug_pt = -1; \\\\\\\\@??!.-5,.+5p\@p FAIL line 380\@q!@;=
@.+2a is.quickexit = 0; \\\\
.
@.,$;f+ extern int xshape;
extern int xorder;
extern int xts;@??!.-5,.+5p\@p FAIL line 427\@q!@;=
@.+2a extern int xqe;
.
@vis 4@wq" $VI -e 'vi.h'
