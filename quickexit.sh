#!/bin/sh
# Generated by patch2vi from unified diff
# Separator: '@'
set -e

# Path to nextvi (adjust as needed)
VI=${VI:-vi}

# Verify that VI is nextvi
if ! $VI -? 2>&1 | grep -q 'Nextvi'; then
    echo "Error: $VI is not nextvi" >&2
    echo "Set VI environment variable to point to nextvi" >&2
    exit 1
fi

# Patch: ex.c
EXINIT="rcm:|sc! @|vis 6@1400a 	EO(qe),
.
@1339a EO(qe)
.
@14a int xqe = 1000;			/* exit insert via kj (delay in ms) */
.
@vis 4@wq" $VI -e 'ex.c'

# Patch: led.c
EXINIT="rcm:|sc! @|vis 6@633a _default:
.
@632a 		case 'j':
			if (xqe && (gettime_ms() - is->quickexit) < xqe) {
				if (len - pre > 0 && sb->s[led_lastchar(sb->s)] == 'k') {
					term_push(\"\", 2);
					continue;
				}
			}
			goto _default;
		case 'k':
			is->quickexit = gettime_ms();
.
@406a static int gettime_ms(void)
{
	struct timespec t;
	if (clock_gettime(CLOCK_MONOTONIC, &t) < 0)
		return 0;
	return t.tv_sec * 1000 + t.tv_nsec / 1000000;
}

.
@vis 4@wq" $VI -e 'led.c'

# Patch: vi.c
EXINIT="rcm:|sc! @|vis 6@1503a 				if (xqe)
					vi_mod |= 2;
.
@9a #include <time.h>
.
@vis 4@wq" $VI -e 'vi.c'

# Patch: vi.h
EXINIT="rcm:|sc! @|vis 6@427a extern int xqe;
.
@380a is.quickexit = 0; \\
.
@372a 	int quickexit;
.
@vis 4@wq" $VI -e 'vi.h'
