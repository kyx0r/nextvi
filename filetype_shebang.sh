#!/bin/sh
# Generated by patch2vi from unified diff
# Separator: '@'
set -e

# Path to nextvi (adjust as needed)
VI=${VI:-vi}

# Verify that VI is nextvi
if ! $VI -? 2>&1 | grep -q 'Nextvi'; then
    echo "Error: $VI is not nextvi" >&2
    echo "Set VI environment variable to point to nextvi" >&2
    exit 1
fi

# Patch: ex.c
EXINIT="rcm:|sc! @|vis 6@377a 	if (!rd && fd >= 0 && lbuf_len(xb) > 0) {
		int adv = 0;
		while (lbuf_len(xb) > adv+1 && xb->ln[adv][0] == '\\n')
			adv++;
		struct filetype lfts[] = {
			{FT(sh), \"^#!.*/(env[ \\t]*)?(sh|bash|zsh|dash)([ \\t]*.*)?\$\"},
			{FT(py), \"^#!.*/(env[ \\t]*)?python3?([ \\t]*.*)?\$\"}
		};
		char *pats[LEN(lfts)];
		for (int i = 0; i < LEN(lfts); i++)
			pats[i] = lfts[i].pat;
		rset *rs = rset_make(LEN(lfts), pats, 0);
		int hl = rset_find(rs, xb->ln[adv], NULL, REG_NEWLINE);
		if (hl >= 0)
			xb_ft = syn_setft(lfts[hl].ft);
		rset_free(rs);
	}
.
@vis 4@wq" $VI -e 'ex.c'
